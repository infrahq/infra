# Encryption Keys

Sensitive data is always encrypted at rest in the db using a symmetric key. The symmetric key is stored in the database encrypted by a root key. By default this root key is generated by Infra and stored in a secret (default: `~/.infra/key`, or in Kubernetes, a as secret named `infra-x` with the key `/__root_key`). Encrpytion at rest can be configured using another key provider service such as KMS or Vault.

The process of retrieving the db key is to load the encrypted key from the database, request that the db key be decrypted by the root key, and at which point the db key is used to decrypt all the data. In the case of AWS KMS and Vault, the Infra app never sees the root key, and so these options are preferred over the default built-in `native` key provider.

### Root key configuration examples	

Infra uses AWS KMS key service:

```yaml	
config:	
  keys:	
    - kind: awskms	
      endpoint: https://your.kms.aws.url.example.com	
      region: us-east-1	
      accessKeyId: kubernetes:awskms/accessKeyID	
      secretAccessKey: kubernetes:awskms/secretAccessKey	
      encryptionAlgorithm: AES_256	
```	

Infra uses Vault as a key service:

```yaml	
config:	
  keys:	
    - kind: vault	
      address: https://your.vault.url.example.com	
      transitMount: /transit	
      token: kubernetes:vault/token	
      namespace: namespace
```	

Another alternative is that Infra can manages its own keys and store them as a secret. Valid secretStorage values are any secrets `name` that is already configured in config under `secrets`, as long as it's one of the types: `file`, `kubernetes`, `vault`, `awsssm` or `awssecretsmanager`. 	

If you're using Kubernetes for root key storage, as the config here shows, you should back up the secret offline or to secret storage such as 1Password. If you don't want to be responsible for backing up this key, switch to Vault or KMS (examples above).	

```yaml	
config:	
  keys:	
    - kind: native	
      secretStorage: kubernetes
```
