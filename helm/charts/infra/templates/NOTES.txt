################################################################################

                                Welcome to Infra

{{- if include "server.enabled" . | eq "true" }}

  Login to this cluster with infra-cli:

    https://github.com/infrahq/infra#install-infra-cli

{{- if .Values.server.ingress.enabled }}
{{- with first .Values.server.ingress.hosts }}

  $ infra login {{ . }}

{{- end }}
{{- else if eq .Values.server.service.type "NodePort" }}

  $ NODE_HOST=$(kubectl -n {{ .Release.Namespace }} get nodes -o jsonpath="{.status.addresses[0].address}")
  $ NODE_PORT=$(kubectl -n {{ .Release.Namespace }} get services/{{ include "server.fullname" . }} -o jsonpath="{.spec.ports[0].nodePort}")
  $ infra login $NODE_HOST:NODE_PORT

{{- else if eq .Values.server.service.type "LoadBalancer" }}

  NOTE: It may take a few minutes for the LoadBalancer to become available.
  You can watch the status of by running `kubectl -n {{ .Release.Namespace }} get services/{{ include "server.fullname" . }} -w`

  $ LOADBALANCER=$(kubectl -n {{ .Release.Namespace }} get services/{{ include "server.fullname" . }} -o jsonpath="{.status.loadBalancer.ingress[*]['ip', 'hostname']}")
  $ infra login $LOADBALANCER

{{- else if contains .Values.server.service.type "ClusterIP" }}

  $ kubectl -n {{ .Release.Namespace }} port-forward deployments/{{ include "server.fullname" . }} 8080:80 8443:443

  Infra API server is now accessible on localhost:8443

  $ infra login localhost:8443

{{- end }}

{{- if not .Values.server.persistence.enabled }}
{{- if and (not (hasKey .Values.server.config "dbHost")) (not .Values.server.config.dbHost) }}

################################# WARNING ######################################

   Server persistence is not enabled. Data will be lost on pod restart
   Enable persistence or connect an external datastore for data integrity.

{{- end }}
{{- end }}
{{- else if .Values.engine.enabled }}

{{- if not .Values.engine.config.name }}

  NOTE: Missing `engine.config.name`. A name will be generated from available
  cluster metadata. If this behaviour is not desired, consider setting a
  name with `engine.config.name`.

{{- end }}

{{- if not .Values.engine.config.server }}

  NOTE: Missing `engine.config.server`. Assuming an in-cluster deployment.
  If this is not correct, set an Infra instance with `engine.config.server`.

{{- end }}

{{- if not .Values.engine.config.accessKey }}

  NOTE: Missing `engine.config.accessKey`. This instance will not be able to
  establish a connection to Infra. If you do not already have an access key,
  generate one using Infra CLI.

  $ infra destinations add kubernetes {{ .Values.engine.config.name | default "my-cluster" }}

  Set an access key with `engine.config.accessKey`.

{{- end }}

{{- if .Values.engine.ingress.enabled }}

{{- else if eq .Values.engine.service.type "LoadBalancer" }}

{{- else }}

  NOTE: This Kubernetes engine is configured with Kubernetes Service
  type {{ .Values.engine.service.type | quote }}. It may not be accessible by Infra or Infra CLI.

  Consider using Service type "LoadBalancer" if problems persist with
  `engine.service.type=LoadBalancer`.

{{- end }}

  Check this cluster has been successfully registered with Infra:

  $ infra destinations list | grep {{ .Values.engine.config.name | default "my-cluster" }}

{{- end }}

################################################################################
